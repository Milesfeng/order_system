kind: pipeline
name: drone-CICD
type: docker

trigger:
  branch: 
    - main
    - Backend/add-store-test
  event: 
    - pull_request

services:
  - name: mysql-server
    image: mysql:5.7
    environment:
      MYSQL_USER: hsipl
      MYSQL_PASSWORD: hsipl211
      MYSQL_ROOT_PASSWORD: hsipl211
      MYSQL_DATABASE: dev_db
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - 3306:3306
    networks:
      - order_net

  - name: redis
    restart: always
    image: redis:alpine
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    networks:
      - order_net


steps:
- name: Run Test
  image: node:latest
  script:
    - bash ./build.sh

- name: ssh commands
  image: appleboy/drone-ssh
  settings:
    host: 
      from_secret: host 
    username: 
      from_secret: user 
    password: 
      from_secret: password 
    port: 22
    script:
      - cd /home/hsipl/feng/Order_System/prd/order_system
      - git pull 

volumes:
  mysql_data:
  backend_data:
  redis_data:

networks:
  order_net:
    driver: bridge